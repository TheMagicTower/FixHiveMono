name: Publish to npm

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'npm tag (beta, latest, etc.)'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta
          - latest
          - next

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Run typecheck
        run: npm run typecheck

      - name: Run tests
        run: npm test
        continue-on-error: true

      - name: Build
        run: npm run build

      - name: Determine npm tag
        id: npm-tag
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_TAG: ${{ inputs.tag }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "tag=$INPUT_TAG" >> $GITHUB_OUTPUT
          elif [[ "$REF_NAME" == *"-beta"* ]] || [[ "$REF_NAME" == *"-alpha"* ]] || [[ "$REF_NAME" == *"-rc"* ]]; then
            echo "tag=beta" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Publish to npm
        run: npm publish --tag ${{ steps.npm-tag.outputs.tag }} --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "## Published to npm" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: @the-magic-tower/fixhive-claude-code" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.npm-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
